<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI 簡報產生器 (v3)</title>
  <meta name="description" content="AI 一鍵生成投影片 + PDF/PPT 下載 + 多格式上傳" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#4f46e5;
      --accent-2:#06b6d4;
      --muted:#94a3b8;
      --text:#e6eef8;
      --glass: rgba(255,255,255,0.03);
      --success:#10b981;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #071021 0%, #071829 100%);
      color:var(--text);
      min-height:100vh;
      padding:28px;
    }
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:20px;align-items:start}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px;font-size:20px}
    .small{color:var(--muted);font-size:13px}
    label{display:block;margin-top:12px;font-weight:600;font-size:14px;color:var(--text)}
    input[type="text"], textarea, select, input[type="number"], input[type="file"]{
      width:100%;
      padding:10px 12px;
      margin-top:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:var(--glass);
      border-radius:8px;
      color:var(--text);
      font-size:14px;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center}
    .radios{display:flex;gap:10px;margin-top:8px}
    .radios label{font-weight:500;color:var(--text);font-size:13px}
    .actions{display:flex;gap:10px;margin-top:14px;align-items:center;flex-wrap:wrap}
    button.primary{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(79,70,229,0.18)
    }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}
    button.download{background:linear-gradient(90deg,#06b6d4,#3b82f6);padding:8px 12px;border-radius:8px;color:white;border:none;cursor:pointer;font-size:13px}
    button:disabled{opacity:0.6;cursor:default}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .status{margin-top:10px;color:var(--muted);font-size:14px}
    .preview{padding:18px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));min-height:120px}
    .slide{border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:10px;margin-bottom:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
    .slide h3{margin:0 0 8px;color:white}
    .slide ul{margin:0 0 8px 18px}
    .pager{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .page-ind{font-weight:700;color:var(--accent)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .progress-bar{width:100%;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;margin-top:8px;display:none}
    .progress-bar > div{width:0%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width 0.3s}
    .file-info{color:var(--success);font-size:12px;margin-top:4px}
    @media (max-width:920px){
      .wrap{grid-template-columns:1fr; padding:0 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 左側控制面板 -->
    <div class="card">
      <div class="topbar">
        <div>
          <h1>AI 簡報產生器</h1>
          <div class="small">支援 Word/PPT/Excel/PDF 上傳 + PDF/PPT 下載</div>
        </div>
        <div class="small">Max 20 頁</div>
      </div>

      <label>簡報主題（必填）</label>
      <input id="topic" type="text" placeholder="例如：AI 對未來工作的影響" />

      <label>補充資料（選填）</label>
      <textarea id="contextText" placeholder="可貼上文章、會議紀錄或重點摘要..."></textarea>

      <label>上傳檔案（支援 .txt, .docx, .pptx, .xlsx, .pdf）</label>
      <input id="fileInput" type="file" accept=".txt,.docx,.pptx,.xlsx,.pdf" />
      <div id="fileInfo" class="file-info"></div>

      <div class="row">
        <div style="flex:1">
          <label>頁數（1 - 20）</label>
          <input id="pageCount" type="number" min="1" max="20" value="5" />
          <div class="small">上限已強制為 20 頁</div>
        </div>
        <div style="width:140px">
          <label>內容豐富度</label>
          <select id="richness">
            <option value="concise">精簡</option>
            <option value="balanced" selected>適中</option>
            <option value="verbose">豐富</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="generateBtn" class="primary">生成簡報</button>
        <button id="clearBtn" class="ghost">清除</button>
        <div id="spinner" class="spinner" style="display:none"></div>
      </div>
      <div class="progress-bar"><div></div></div>

      <div id="status" class="status"></div>

      <div style="margin-top:12px" class="small">
        <strong>小提示：</strong> 上傳檔案後會自動提取文字作為補充資料。生成後可下載 PDF 或 PPT 檔案。
      </div>
    </div>

    <!-- 右側展示區 -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <h2 style="margin:0">生成結果</h2>
          <div class="small">模型會回傳每頁標題、要點與備註</div>
        </div>
        <div id="exportButtons" style="display:none"></div>
      </div>

      <div id="resultArea" class="preview">
        <div id="emptyNotice" class="small">尚未生成，請輸入主題並按「生成簡報」。</div>

        <div id="slidesContainer" style="display:none"></div>

        <div id="pagerControls" style="display:none" class="pager">
          <button id="prevPage" class="ghost">← 上一頁</button>
          <div class="page-ind" id="pageIndicator">第 1 / 1 頁</div>
          <button id="nextPage" class="ghost">下一頁 →</button>
        </div>

        <div id="rawBox" style="display:none;margin-top:12px">
          <h4 style="margin:6px 0">原始回傳（解析失敗時顯示）</h4>
          <pre id="rawText" style="white-space:pre-wrap;max-height:220px;overflow:auto;background:#021024;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const topicEl = document.getElementById('topic');
      const contextEl = document.getElementById('contextText');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const pageCountEl = document.getElementById('pageCount');
      const richnessEl = document.getElementById('richness');
      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');
      const spinner = document.getElementById('spinner');
      const progressBar = document.querySelector('.progress-bar > div');
      const statusEl = document.getElementById('status');
      const emptyNotice = document.getElementById('emptyNotice');
      const slidesContainer = document.getElementById('slidesContainer');
      const pagerControls = document.getElementById('pagerControls');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const pageIndicator = document.getElementById('pageIndicator');
      const rawBox = document.getElementById('rawBox');
      const rawText = document.getElementById('rawText');
      const exportButtons = document.getElementById('exportButtons');

      let slides = [];
      let currentIndex = 0;

      // 讀取檔案為 base64
      async function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // 顯示進度
      function showProgress(percent) {
        document.querySelector('.progress-bar').style.display = 'block';
        progressBar.style.width = percent + '%';
      }
      function hideProgress() {
        document.querySelector('.progress-bar').style.display = 'none';
      }

      // 顯示狀態
      function showStatus(msg, isError = false) {
        statusEl.textContent = msg;
        statusEl.style.color = isError ? '#ef4444' : 'var(--muted)';
      }

      // 顯示 spinner
      function showSpinner(show) {
        spinner.style.display = show ? 'inline-block' : 'none';
      }

      // 渲染單頁
      function renderSlide(idx) {
        if (!slides || slides.length === 0) return;
        slidesContainer.innerHTML = '';
        const s = slides[idx];
        const div = document.createElement('div');
        div.className = 'slide';
        const title = document.createElement('h3');
        title.textContent = s.title || ('第 ' + (idx+1) + ' 頁');
        div.appendChild(title);

        if (Array.isArray(s.bullets) && s.bullets.length > 0){
          const ul = document.createElement('ul');
          s.bullets.forEach(b => {
            const li = document.createElement('li');
            li.textContent = b;
            ul.appendChild(li);
          });
          div.appendChild(ul);
        } else {
          const p = document.createElement('div');
          p.className = 'small';
          p.textContent = '(無要點)';
          div.appendChild(p);
        }

        if (s.notes) {
          const notes = document.createElement('div');
          notes.className = 'small';
          notes.style.marginTop = '8px';
          notes.textContent = '備註：' + s.notes;
          div.appendChild(notes);
        }

        slidesContainer.appendChild(div);
        pageIndicator.textContent = `第 ${idx+1} / ${slides.length} 頁`;
      }

      // 顯示所有 slides
      function showSlides(mySlides){
        slides = Array.isArray(mySlides) ? mySlides : [];
        if (slides.length === 0){
          slidesContainer.style.display = 'none';
          pagerControls.style.display = 'none';
          emptyNotice.style.display = 'block';
          exportButtons.style.display = 'none';
          return;
        }
        emptyNotice.style.display = 'none';
        slidesContainer.style.display = 'block';
        pagerControls.style.display = 'flex';
        rawBox.style.display = 'none';
        currentIndex = 0;
        renderSlide(currentIndex);
        exportButtons.style.display = 'flex';
        exportButtons.innerHTML = '';
        const pdfBtn = document.createElement('button');
        pdfBtn.className = 'download';
        pdfBtn.textContent = '下載 PDF';
        pdfBtn.onclick = () => exportFile('pdf');
        exportButtons.appendChild(pdfBtn);
        const pptBtn = pdfBtn.cloneNode(true);
        pptBtn.textContent = '下載 PPT';
        pptBtn.onclick = () => exportFile('pptx');
        exportButtons.appendChild(pptBtn);
      }

      // 匯出檔案
      async function exportFile(format) {
        showStatus('正在產生檔案中...');
        try {
          const resp = await fetch('/api/export', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ slides, format })
          });
          if (!resp.ok) throw new Error('匯出失敗');
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `簡報.${format === 'pptx' ? 'pptx' : 'pdf'}`;
          a.click();
          URL.revokeObjectURL(url);
          showStatus('匯出成功！');
        } catch (e) {
          showStatus('匯出失敗：' + e.message, true);
        }
      }

      // 頁碼控制
      prevPageBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderSlide(currentIndex);
        }
      });
      nextPageBtn.addEventListener('click', () => {
        if (currentIndex < slides.length - 1) {
          currentIndex++;
          renderSlide(currentIndex);
        }
      });

      // 清除
      clearBtn.addEventListener('click', () => {
        topicEl.value = '';
        contextEl.value = '';
        fileInput.value = '';
        fileInfo.textContent = '';
        pageCountEl.value = 5;
        richnessEl.value = 'balanced';
        slidesContainer.innerHTML = '';
        slides = [];
        emptyNotice.style.display = 'block';
        pagerControls.style.display = 'none';
        exportButtons.style.display = 'none';
        rawBox.style.display = 'none';
        showStatus('');
        hideProgress();
      });

      // 檔案變更
      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          fileInfo.textContent = `已選取：${file.name} (${(file.size/1024).toFixed(1)} KB)`;
        } else {
          fileInfo.textContent = '';
        }
      });

      // 生成按鈕
      generateBtn.addEventListener('click', async () => {
        showStatus('');
        rawBox.style.display = 'none';
        const topic = topicEl.value.trim();
        if (!topic) {
          showStatus('請輸入簡報主題。', true);
          return;
        }
        let pageCount = parseInt(pageCountEl.value) || 5;
        pageCount = Math.max(1, Math.min(pageCount, 20));
        const richness = richnessEl.value || 'balanced';

        let fileBase64 = '';
        const file = fileInput.files[0];
        if (file) {
          showProgress(10);
          try {
            fileBase64 = await readFileAsBase64(file);
            showProgress(30);
          } catch (e) {
            showStatus('檔案讀取失敗。', true);
            return;
          }
        }

        generateBtn.disabled = true;
        showSpinner(true);
        showProgress(50);
        showStatus('正在請求 AI 生成中...');

        try {
          const payload = { topic, fileBase64, pageCount, richness };
          const resp = await fetch('/api/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });

          showProgress(80);
          const text = await resp.text();
          let json;
          try { json = JSON.parse(text); } catch(e) { json = null; }

          if (!resp.ok) {
            let msg = `伺服器錯誤：${resp.status}`;
            if (json && json.error) msg += ' — ' + json.error;
            showStatus(msg, true);
            rawText.textContent = text;
            rawBox.style.display = 'block';
            return;
          }

          if (json && json.ok === true && Array.isArray(json.slides)) {
            showStatus('生成完成！');
            showSlides(json.slides);
            showProgress(100);
            setTimeout(hideProgress, 500);
          } else {
            showStatus('生成失敗，回傳格式錯誤。', true);
            rawText.textContent = text;
            rawBox.style.display = 'block';
          }

        } catch (err) {
          console.error(err);
          showStatus('發生錯誤：' + (err.message || err), true);
        } finally {
          generateBtn.disabled = false;
          showSpinner(false);
        }
      });

      // 初始狀態
      emptyNotice.style.display = 'block';
    })();
  </script>
</body>
</html>
